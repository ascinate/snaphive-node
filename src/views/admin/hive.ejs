<%- include("../components/adminHeader", { title }) %>
  <%- include("../components/adminSidebar") %>

    <div class="container">

      <!-- Filters -->
      <form method="GET" class="mb-3">
        <input type="text" name="search" placeholder="Search Hive name or ID" value="<%= query.search || '' %>">

        <select name="privacy">
          <option value="">All Privacy</option>
          <option value="automatic">Public</option>
          <option value="approval">Private</option>
        </select>

        <input type="date" name="date" value="<%= query.date || '' %>">

        <button type="submit">Filter</button>
      </form>

      <!-- Hive Table -->
      <table border="1" width="100%" cellpadding="10">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>#</th>
            <th>Hive Name</th>
            <th>Owner</th>
            <th>Privacy</th>
            <th>Images</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          <% hives.forEach((hive, index)=> { %>
            <tr>
              <td><input type="checkbox" value="<%= hive._id %>"></td>
              <td>
                <%= index + 1 %>
              </td>
              <td>
                <%= hive.hiveName %>
              </td>
              <td>
                <%= hive.user?.name || "N/A" %><br>
                  <small>
                    <%= hive.user?.email %>
                  </small>
              </td>
              <td>
                <%= hive.privacyMode %>
              </td>
              <td>
                <%= hive.images.length %>
              </td>
              <td>
                
              </td>
              <td>
                <%= hive.createdAt.toDateString() %>
              </td>
              <td>
                <button onclick="openDetails('<%= hive._id %>')">View</button>
                <button onclick="openImages('<%= hive._id %>')">Images</button>
                <button onclick="openStatus('<%= hive._id %>')">Status</button>
                <button onclick="openFlag('<%= hive._id %>')">Flag</button>
              </td>

            </tr>
            <% }) %>
        </tbody>
      </table>
      <!-- Pagination -->
      <% if (pagination.totalPages> 1) { %>
        <div style="margin-top:20px; text-align:center;">

          <% if (pagination.currentPage> 1) { %>
            <a href="?<%= new URLSearchParams({ ...query, page: pagination.currentPage - 1 }).toString() %>">
              ◀ Prev
            </a>
            <% } %>

              <% for (let i=1; i <=pagination.totalPages; i++) { %>
                <a href="?<%= new URLSearchParams({ ...query, page: i }).toString() %>"
                  style="margin:0 5px; <%= pagination.currentPage === i ? 'font-weight:bold;' : '' %>">
                  <%= i %>
                </a>
                <% } %>

                  <% if (pagination.currentPage < pagination.totalPages) { %>
                    <a href="?<%= new URLSearchParams({ ...query, page: pagination.currentPage + 1 }).toString() %>">
                      Next ▶
                    </a>
                    <% } %>

        </div>
        <% } %>


    </div>
    <div id="adminModal"
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);">
      <div style="background:#fff; width:600px; margin:5% auto; padding:20px; position:relative;">
        <h3 id="modalTitle"></h3>
        <div id="modalBody"></div>
        <button onclick="closeModal()">Close</button>
      </div>
    </div>


    <%- include("../components/adminFooter") %>
    <script>
  const modal = document.getElementById("adminModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");

  function openModal(title, content) {
    modalTitle.innerText = title;
    modalBody.innerHTML = content;
    modal.style.display = "block";
  }

  function closeModal() {
    modal.style.display = "none";
    modalBody.innerHTML = "";
  }


 async function openDetails(hiveId) {
  const res = await fetch(`/hive/${hiveId}`);
  const { hive } = await res.json();

  openModal("Hive Details", `
    <div class="hive-modal">
      
      <div class="hive-cover">
        ${
          hive.coverImage
            ? `<img src="${hive.coverImage}" alt="Hive Cover">`
            : `<div class="no-cover">No Cover Image</div>`
        }
      </div>

      <div class="hive-body">
        <div class="hive-row">
          <span>Name</span>
          <strong>${hive.hiveName}</strong>
        </div>

        <div class="hive-row">
          <span>Owner</span>
          <strong>${hive.user?.name || "N/A"}</strong>
        </div>

        <div class="hive-row">
          <span>Email</span>
          <strong>${hive.user?.email || "—"}</strong>
        </div>

        <div class="hive-row">
          <span>Privacy</span>
          <span class="badge ${hive.privacyMode}">
            ${hive.privacyMode}
          </span>
        </div>

        <div class="hive-row description">
          <span>Description</span>
          <p>${hive.description || "No description provided."}</p>
        </div>

        <div class="hive-footer">
          Created on ${new Date(hive.createdAt).toDateString()}
        </div>

      </div>
    </div>
  `);
}



async function openImages(hiveId) {
  const res = await fetch(`/hive/${hiveId}/images`);
  const { images } = await res.json();

  if (!images.length) {
    openModal("Hive Images", `
      <div class="empty-state">
        No images found for this Hive
      </div>
    `);
    return;
  }

  let html = `
    <div class="hive-images-grid">
  `;

  images.forEach((img) => {
    html += `
      <div class="image-card">
        <img src="${img}" alt="Hive Image" />

        <button 
          class="remove-btn"
          onclick="removeHiveImage('${hiveId}', '${img}')">
          ✕
        </button>
      </div>
    `;
  });

  html += `</div>`;

  openModal("Hive Images", html);
}

async function removeHiveImage(hiveId, imageUrl) {
  if (!confirm("Remove this image from Hive?")) return;

  const res = await fetch(`/hive/${hiveId}/image`, {
    method: "DELETE",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ image: imageUrl }),
  });

  if (res.ok) {
    openImages(hiveId); // refresh modal
  } else {
    alert("Failed to remove image");
  }
}


  function openStatus(hiveId) {
    openModal("Change Hive Status", `
      <form method="POST" action="/hive/${hiveId}/status">
        <select name="status">
          <option value="active">Active</option>
          <option value="hidden">Hidden</option>
          <option value="deleted">Deleted</option>
        </select>
        <button type="submit">Update</button>
      </form>
    `);
  }

  // 4️⃣ Flag Hive
  function openFlag(hiveId) {
    openModal("Flag Hive", `
      <form method="POST" action="/hive/${hiveId}/flag">
        <textarea name="reason" placeholder="Reason" required></textarea>
        <button type="submit">Flag</button>
      </form>
    `);
  }
</script>
