<%- include("../components/adminHeader", { title }) %>
  <%- include("../components/adminSidebar") %>

    <div class="container">
      <h2>User Management</h2>

      <!-- ðŸ” Search -->
      <form method="GET" action="/user" style="margin-bottom:15px;">
        <input type="text" name="search" value="<%= search || '' %>" placeholder="Search name or email"
          style="padding:6px;width:250px;" />
        <button type="submit">Search</button>
      </form>

      <table border="1" width="100%" cellpadding="10">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Verified</th>
            <th>Joined</th>
            <th>Action</th>

          </tr>
        </thead>

        <tbody>
          <% if (!users || users.length===0) { %>
            <tr>
              <td colspan="5" align="center">No users found</td>
            </tr>
            <% } %>

              <% users.forEach((user, index)=> { %>
                <tr>
                  <td>
                    <%= (currentPage - 1) * 10 + index + 1 %>
                  </td>
                  <td>
                    <%= user.name || "â€”" %>
                  </td>
                  <td>
                    <%= user.email %>
                  </td>
                  <td style="color:<%= user.isVerified ? 'green' : 'red' %>">
                    <%= user.isVerified ? "Yes" : "No" %>
                  </td>
                  <td>
                    <%= new Date(user.createdAt).toDateString() %>
                  </td>
                  <td>
                    <button onclick="openUserModal('<%= user._id %>')">
                      View
                    </button>
                  </td>

                </tr>
                <% }) %>
        </tbody>
      </table>

      <!-- Pagination -->
      <% if (totalPages> 1) { %>
        <div style="margin-top:20px;">
          <% for (let i=1; i <=totalPages; i++) { %>
            <a href="/user?page=<%= i %>&search=<%= search || '' %>" style="
            margin-right:5px;
            padding:6px 10px;
            text-decoration:none;
            border:1px solid #ccc;
            <%= currentPage === i ? 'background:#333;color:#fff;' : '' %>
          ">
              <%= i %>
            </a>
            <% } %>
        </div>
        <% } %>
    </div>
    <div id="userModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5)">
      <div style="background:#fff; width:500px; margin:80px auto; padding:20px; position:relative">
        <h3>User Profile</h3>

        <div id="modalContent">Loading...</div>

        <button onclick="closeUserModal()">Close</button>
      </div>
    </div>





    <%- include("../components/adminFooter") %>

      <script>
        async function openUserModal(userId) {
          document.getElementById("userModal").style.display = "block";
          document.getElementById("modalContent").innerHTML = "Loading...";

          const res = await fetch(`/user/profile/${userId}`);
          const data = await res.json();

          const u = data.user;

          document.getElementById("modalContent").innerHTML = `
      <img src="${u.profileImage || '/images/avatar.png'}" width="80" /><br/><br/>

      <strong>Name:</strong> ${u.name || "â€”"}<br/>
      <strong>Email:</strong> ${u.email}<br/>
      <strong>Signup Date:</strong> ${new Date(u.createdAt).toLocaleDateString()}<br/>
      <strong>Device:</strong> ${u.deviceType}<br/>
      <strong>Last Login:</strong> ${u.lastLogin ? new Date(u.lastLogin).toLocaleString() : "â€”"}<br/>
      <strong>Hives Created:</strong> ${data.hiveCount}<br/>
      <strong>Status:</strong>
${!u.isDeleted ? `
  <a href="/user/toggle/${u._id}">
    ${u.isActive ? "Block User" : "Activate User"}
  </a>
  |
  <a href="/user/delete/${u._id}" onclick="return confirm('Soft delete user?')">
    Soft Delete
  </a>
` : `<em>User is deleted</em>`}

      |
      <a href="/user/reset/${u._id}">
        Reset Account
      </a>
    `;
        }

        function closeUserModal() {
          document.getElementById("userModal").style.display = "none";
        }
      </script>